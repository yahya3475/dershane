@using Microsoft.AspNetCore.Mvc.Rendering
@{
    ViewData["Title"] = "Take Attendance";
}

<div class="container-fluid mt-4">
    <div class="card shadow-sm">
        <div class="card-body">
            <h2 class="card-title mb-4">
                <i class="bi bi-check2-square me-2"></i>Take Attendance
            </h2>
            
            <div class="row mb-4">
                <div class="col-md-4">
                    <label for="lessonSelect" class="form-label">Subject</label>
                    <select class="form-select" id="lessonSelect">
                        <option value="">Select Subject</option>
                        @if (ViewBag.Lessons != null)
                        {
                            @foreach (var lesson in (List<SelectListItem>)ViewBag.Lessons)
                            {
                                <option value="@lesson.Value">@lesson.Text</option>
                            }
                        }
                    </select>
                </div>
                <div class="col-md-4">
                    <label for="dateInput" class="form-label">Date</label>
                    <input type="date" class="form-control" id="dateInput" value="@DateTime.Now.ToString("yyyy-MM-dd")">
                </div>
                <div class="col-md-4">
                    <label class="form-label">&nbsp;</label>
                    <button type="button" class="btn btn-primary d-block" onclick="loadStudents()">
                        <i class="bi bi-search me-2"></i>Load Students
                    </button>
                </div>
            </div>

            <div id="studentsContainer" style="display: none;">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5>Student List</h5>
                    <div>
                        <button type="button" class="btn btn-sm btn-success me-2" onclick="markAllPresent()">
                            <i class="bi bi-check-all me-1"></i>Mark All Present
                        </button>
                        <button type="button" class="btn btn-sm btn-danger" onclick="markAllAbsent()">
                            <i class="bi bi-x-square me-1"></i>Mark All Absent
                        </button>
                    </div>
                </div>

                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead class="table-dark">
                            <tr>
                                <th>Student ID</th>
                                <th>Student Name</th>
                                <th>Status</th>
                                <th>Note</th>
                            </tr>
                        </thead>
                        <tbody id="studentsTableBody">
                        </tbody>
                    </table>
                </div>

                <div class="text-end mt-3">
                    <button type="button" class="btn btn-success" onclick="saveAttendance()">
                        <i class="bi bi-save me-2"></i>Save Attendance
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function loadStudents() {
    const lesson = document.getElementById('lessonSelect').value;
    const date = document.getElementById('dateInput').value;
    
    if (!lesson || !date) {
        alert('Please select subject and date.');
        return;
    }

    fetch('/Teacher/GetStudentsForAttendance', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: `lesson=${encodeURIComponent(lesson)}&date=${encodeURIComponent(date)}`
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            displayStudents(data.students);
            document.getElementById('studentsContainer').style.display = 'block';
        } else {
            alert(data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred.');
    });
}

function displayStudents(students) {
    const tbody = document.getElementById('studentsTableBody');
    tbody.innerHTML = '';
    
    students.forEach(student => {
        const row = `
            <tr>
                <td>${student.studentId}</td>
                <td>${student.studentName}</td>
                <td>
                    <div class="form-check form-switch">
                        <input class="form-check-input attendance-switch" type="checkbox" 
                               data-student-id="${student.studentId}" 
                               ${student.isPresent ? 'checked' : ''}>
                        <label class="form-check-label attendance-label">
                            ${student.isPresent ? 'Present' : 'Absent'}
                        </label>
                    </div>
                </td>
                <td>
                    <input type="text" class="form-control form-control-sm attendance-note" 
                           data-student-id="${student.studentId}" 
                           value="${student.note || ''}" 
                           placeholder="Note (optional)">
                </td>
            </tr>
        `;
        tbody.innerHTML += row;
    });
    
    document.querySelectorAll('.attendance-switch').forEach(switchEl => {
        switchEl.addEventListener('change', function() {
            const label = this.parentElement.querySelector('.attendance-label');
            label.textContent = this.checked ? 'Present' : 'Absent';
        });
    });
}

function markAllPresent() {
    document.querySelectorAll('.attendance-switch').forEach(switchEl => {
        switchEl.checked = true;
        switchEl.parentElement.querySelector('.attendance-label').textContent = 'Present';
    });
}

function markAllAbsent() {
    document.querySelectorAll('.attendance-switch').forEach(switchEl => {
        switchEl.checked = false;
        switchEl.parentElement.querySelector('.attendance-label').textContent = 'Absent';
    });
}

function saveAttendance() {
    const lesson = document.getElementById('lessonSelect').value;
    const date = document.getElementById('dateInput').value;
    
    if (!lesson || !date) {
        alert('Please select subject and date.');
        return;
    }
    
    const students = [];
    document.querySelectorAll('.attendance-switch').forEach(switchEl => {
        const studentId = switchEl.getAttribute('data-student-id');
        const isPresent = switchEl.checked;
        const note = document.querySelector(`.attendance-note[data-student-id="${studentId}"]`).value;
        
        students.push({
            studentId: studentId,
            isPresent: isPresent,
            note: note
        });
    });
    
    const data = {
        lesson: lesson,
        date: date,
        students: students
    };
    
    fetch('/Teacher/SaveAttendance', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Attendance saved successfully!');
            document.getElementById('studentsContainer').style.display = 'none';
            document.getElementById('lessonSelect').value = '';
            document.getElementById('dateInput').value = '@DateTime.Now.ToString("yyyy-MM-dd")';
        } else {
            alert('Error: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred.');
    });
}
</script>