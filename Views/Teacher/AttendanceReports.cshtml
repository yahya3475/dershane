@using System.Linq
@model List<dershane.ViewModels.AttendanceReportVM>
@{
    ViewData["Title"] = "Attendance Reports";
}

<div class="container-fluid mt-4">
    <div class="card shadow-sm">
        <div class="card-body">
            <h2 class="card-title mb-4">
                <i class="bi bi-file-earmark-text me-2"></i>Attendance Reports
            </h2>
            
            <div class="row mb-4">
                <div class="col-md-3">
                    <label for="lessonFilter" class="form-label">Subject</label>
                    <select class="form-select" id="lessonFilter">
                        <option value="">All Subjects</option>
                        @if (ViewBag.Lessons != null)
                        {
                            @foreach (var lesson in (List<SelectListItem>)ViewBag.Lessons)
                            {
                                <option value="@lesson.Value">@lesson.Text</option>
                            }
                        }
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="startDate" class="form-label">Start Date</label>
                    <input type="date" class="form-control" id="startDate" value="@ViewBag.StartDate">
                </div>
                <div class="col-md-3">
                    <label for="endDate" class="form-label">End Date</label>
                    <input type="date" class="form-control" id="endDate" value="@ViewBag.EndDate">
                </div>
                <div class="col-md-3">
                    <label class="form-label">&nbsp;</label>
                    <button type="button" class="btn btn-primary d-block" onclick="filterReports()">
                        <i class="bi bi-funnel me-2"></i>Filter
                    </button>
                </div>
            </div>

            @if (Model != null && Model.Any())
            {
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead class="table-dark">
                            <tr>
                                <th>Date</th>
                                <th>Subject</th>
                                <th>Student ID</th>
                                <th>Student Name</th>
                                <th>Status</th>
                                <th>Note</th>
                            </tr>
                        </thead>
                        <tbody id="reportsTableBody">
                            @foreach (var report in Model)
                            {
                                <tr>
                                    <td>@report.Date.ToString("dd.MM.yyyy")</td>
                                    <td>@report.Lesson</td>
                                    <td>@report.StudentId</td>
                                    <td>@report.StudentName</td>
                                    <td>
                                        @if (report.IsPresent)
                                        {
                                            <span class="badge bg-success">Present</span>
                                        }
                                        else
                                        {
                                            <span class="badge bg-danger">Absent</span>
                                        }
                                    </td>
                                    <td>@(report.Note ?? "-")</td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
                
                <div class="mt-3">
                    <button type="button" class="btn btn-success" onclick="exportToExcel()">
                        <i class="bi bi-file-earmark-excel me-2"></i>Export to Excel
                    </button>
                </div>
            }
            else
            {
                <div class="alert alert-info" role="alert">
                    <i class="bi bi-info-circle me-2"></i>No attendance records found.
                </div>
            }
        </div>
    </div>
</div>

<script>
function filterReports() {
    const lesson = document.getElementById('lessonFilter').value;
    const startDate = document.getElementById('startDate').value;
    const endDate = document.getElementById('endDate').value;
    
    const params = new URLSearchParams();
    if (lesson) params.append('lesson', lesson);
    if (startDate) params.append('startDate', startDate);
    if (endDate) params.append('endDate', endDate);
    
    window.location.href = '/Teacher/AttendanceReports?' + params.toString();
}

function exportToExcel() {
    const lesson = document.getElementById('lessonFilter').value;
    const startDate = document.getElementById('startDate').value;
    const endDate = document.getElementById('endDate').value;
    
    const params = new URLSearchParams();
    if (lesson) params.append('lesson', lesson);
    if (startDate) params.append('startDate', startDate);
    if (endDate) params.append('endDate', endDate);
    
    window.location.href = '/Teacher/ExportAttendanceToExcel?' + params.toString();
}
</script>